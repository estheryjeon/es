<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noindex, nofollow">
        <title>E&S</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="main.css" rel="stylesheet" type="text/css">
        <script src="main.js"></script>
    </head>
  <body>
    <iframe id="contentFrame" frameBorder="0" allowfullscreen></iframe>
    <div id="dialogWrap">
        <div id="dialogWrapCell">
            <div id="mainDialog">
                <h3><div id="dialogText">Enter password to see details</div></h3>
                <div id="passArea">
                    <label id="passwordPrompt">Password</label>
                    <input class="text-box" id="pass" type="password" name="pass" autofocus>
                    <div id="messageWrapper">
                        <p id="invalidPass" class="error">Sorry, please try again.</p>
                        <p id="trycatcherror" class="error">Sorry, something went wrong.</p>
                        <p id="success" class="notifyText">Success!</p>
                        &nbsp;
                    </div>
                    <div>
                        <button id="submitPass" type="button">Submit</button>
                        <div style="clear: both;"></div>
                    </div>
                    <p class="rsvpPs">P.S. This password is on your invitation!</p>
                </div>
                <div id="securecontext" class="error">
                    <p>
                        Sorry, but password protection only works over a secure connection. Please load this page via HTTPS.
                    </p>
                </div>
                <div id="nocrypto" class="error">
                    <p>
                        Your web browser appears to be outdated. Please visit this page using a modern browser.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div id="attribution">
        Protected by <a href="https://www.maxlaumeister.com/pagecrypt/">PageCrypt</a>
    </div>
    <script>
    (function() {

        var pl = "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";
        
        var submitPass = document.getElementById('submitPass');
        var passEl = document.getElementById('pass');
        var invalidPassEl = document.getElementById('invalidPass');
        var trycatcherror = document.getElementById('trycatcherror');
        var successEl = document.getElementById('success');
        var contentFrame = document.getElementById('contentFrame');
        
        // Sanity checks

        if (pl === "") {
            submitPass.disabled = true;
            passEl.disabled = true;
            alert("This page is meant to be used with the encryption tool. It doesn't work standalone.");
            return;
        }

        if (!isSecureContext) {
            document.querySelector("#passArea").style.display = "none";
            document.querySelector("#securecontext").style.display = "block";
            return;
        }

        if (!crypto.subtle) {
            document.querySelector("#passArea").style.display = "none";
            document.querySelector("#nocrypto").style.display = "block";
            return;
        }
        
        function str2ab(str) {
            var ustr = atob(str);
            var buf = new ArrayBuffer(ustr.length);
            var bufView = new Uint8Array(buf);
            for (var i=0, strLen=ustr.length; i < strLen; i++) {
                bufView[i] = ustr.charCodeAt(i);
            }
            return bufView;
        }

        async function deriveKey(salt, password) {
            const encoder = new TextEncoder()
            const baseKey = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveKey'],
            )
            return await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
                baseKey,
                { name: 'AES-GCM', length: 256 },
                true,
                ['decrypt'],
            )
        }
        
        async function doSubmit(evt) {
            submitPass.disabled = true;
            passEl.disabled = true;

            let iv, ciphertext, key;
            
            try {
                var unencodedPl = str2ab(pl);

                const salt = unencodedPl.slice(0, 32)
                iv = unencodedPl.slice(32, 32 + 16)
                ciphertext = unencodedPl.slice(32 + 16)

                key = await deriveKey(salt, passEl.value);
            } catch (e) {
                trycatcherror.style.display = "inline";
                console.error(e);
                return;
            }

            try {
                const decryptedArray = new Uint8Array(
                    await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ciphertext)
                );

                let decrypted = new TextDecoder().decode(decryptedArray);

                if (decrypted === "") throw "No data returned";

                const basestr = '<base href="." target="_top">';
                const anchorfixstr = `
                    <script>
                        Array.from(document.links).forEach((anchor) => {
                            const href = anchor.getAttribute("href");
                            if (href.startsWith("#")) {
                                anchor.addEventListener("click", function(e) {
                                    e.preventDefault();
                                    const targetId = this.getAttribute("href").substring(1);
                                    const targetEl = document.getElementById(targetId);
                                    targetEl.scrollIntoView();
                                });
                            }
                        });
                    <\/script>
                `;
                
                // Set default iframe link targets to _top so all links break out of the iframe
                if (decrypted.includes("<head>")) decrypted = decrypted.replace("<head>", "<head>" + basestr);
                else if (decrypted.includes("<!DOCTYPE html>")) decrypted = decrypted.replace("<!DOCTYPE html>", "<!DOCTYPE html>" + basestr);
                else decrypted = basestr + decrypted;

                // Fix fragment links
                if (decrypted.includes("</body>")) decrypted = decrypted.replace("</body>", anchorfixstr + '</body>');
                else if (decrypted.includes("</html>")) decrypted = decrypted.replace("</html>", anchorfixstr + '</html>');
                else decrypted = decrypted + anchorfixstr;
                
                contentFrame.srcdoc = decrypted;
                
                successEl.style.display = "inline";
                setTimeout(function() {
                    dialogWrap.style.display = "none";
                }, 1000);
            } catch (e) {
                invalidPassEl.style.display = "inline";
                passEl.value = "";
                submitPass.disabled = false;
                passEl.disabled = false;
                console.error(e);
                return;
            }
        }
        
        submitPass.onclick = doSubmit;
        passEl.onkeypress = function(e){
            if (!e) e = window.event;
            var keyCode = e.keyCode || e.which;
            invalidPassEl.style.display = "none";
            if (keyCode == '13'){
              // Enter pressed
              doSubmit();
              return false;
            }
        }
    })();
    </script>
  </body>
</html>
