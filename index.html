<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>E&S</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="main.css" rel="stylesheet" type="text/css">
    <script src="main.js"></script>
</head>
<body>
    <iframe id="contentFrame" frameBorder="0" allowfullscreen></iframe>
    <div id="dialogWrap">
        <div id="dialogWrapCell">
            <div id="mainDialog">
                <h3 id="dialogText">Enter password to see details</h3>
                <div id="passArea">
                    <label id="passwordPrompt">Password</label>
                    <input id="pass" type="password" name="pass" autofocus>
                    <div id="messageWrapper">
                        <p id="invalidPass" class="error">Sorry, please try again.</p>
                        <p id="trycatcherror" class="error">Sorry, something went wrong.</p>
                        <p id="success" class="notifyText">Success!</p>
                        &nbsp;
                    </div>
                    <div>
                        <button id="submitPass" type="button">Submit</button>
                        <div style="clear: both;"></div>
                    </div>
                    <p class="rsvpPs">P.S. This password is on your invitation!</p>
                </div>
                <div id="securecontext" class="error">
                    <p>
                        Sorry, but password protection only works over a secure connection. Please load this page via HTTPS.
                    </p>
                </div>
                <div id="nocrypto" class="error">
                    <p>
                        Your web browser appears to be outdated. Please visit this page using a modern browser.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <script>
    (function() {

        var pl = "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";
        
        var submitPass = document.getElementById('submitPass');
        var passEl = document.getElementById('pass');
        var invalidPassEl = document.getElementById('invalidPass');
        var trycatcherror = document.getElementById('trycatcherror');
        var successEl = document.getElementById('success');
        var contentFrame = document.getElementById('contentFrame');
        
        // Sanity checks

        if (pl === "") {
            submitPass.disabled = true;
            passEl.disabled = true;
            alert("This page is meant to be used with the encryption tool. It doesn't work standalone.");
            return;
        }

        if (!isSecureContext) {
            document.querySelector("#passArea").style.display = "none";
            document.querySelector("#securecontext").style.display = "block";
            return;
        }

        if (!crypto.subtle) {
            document.querySelector("#passArea").style.display = "none";
            document.querySelector("#nocrypto").style.display = "block";
            return;
        }
        
        function str2ab(str) {
            var ustr = atob(str);
            var buf = new ArrayBuffer(ustr.length);
            var bufView = new Uint8Array(buf);
            for (var i=0, strLen=ustr.length; i < strLen; i++) {
                bufView[i] = ustr.charCodeAt(i);
            }
            return bufView;
        }

        async function deriveKey(salt, password) {
            const encoder = new TextEncoder()
            const baseKey = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveKey'],
            )
            return await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
                baseKey,
                { name: 'AES-GCM', length: 256 },
                true,
                ['decrypt'],
            )
        }
        
        async function doSubmit(evt) {
            submitPass.disabled = true;
            passEl.disabled = true;

            let iv, ciphertext, key;
            
            try {
                var unencodedPl = str2ab(pl);

                const salt = unencodedPl.slice(0, 32)
                iv = unencodedPl.slice(32, 32 + 16)
                ciphertext = unencodedPl.slice(32 + 16)

                key = await deriveKey(salt, passEl.value);
            } catch (e) {
                trycatcherror.style.display = "inline";
                console.error(e);
                return;
            }

            try {
                const decryptedArray = new Uint8Array(
                    await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ciphertext)
                );

                let decrypted = new TextDecoder().decode(decryptedArray);

                if (decrypted === "") throw "No data returned";

                const basestr = '<base href="." target="_top">';
                const anchorfixstr = `
                    <script>
                        Array.from(document.links).forEach((anchor) => {
                            const href = anchor.getAttribute("href");
                            if (href.startsWith("#")) {
                                anchor.addEventListener("click", function(e) {
                                    e.preventDefault();
                                    const targetId = this.getAttribute("href").substring(1);
                                    const targetEl = document.getElementById(targetId);
                                    targetEl.scrollIntoView();
                                });
                            }
                        });
                    <\/script>
                `;
                
                // Set default iframe link targets to _top so all links break out of the iframe
                if (decrypted.includes("<head>")) decrypted = decrypted.replace("<head>", "<head>" + basestr);
                else if (decrypted.includes("<!DOCTYPE html>")) decrypted = decrypted.replace("<!DOCTYPE html>", "<!DOCTYPE html>" + basestr);
                else decrypted = basestr + decrypted;

                // Fix fragment links
                if (decrypted.includes("</body>")) decrypted = decrypted.replace("</body>", anchorfixstr + '</body>');
                else if (decrypted.includes("</html>")) decrypted = decrypted.replace("</html>", anchorfixstr + '</html>');
                else decrypted = decrypted + anchorfixstr;
                
                contentFrame.srcdoc = decrypted;
                
                successEl.style.display = "inline";
                setTimeout(function() {
                    dialogWrap.style.display = "none";
                }, 1000);
            } catch (e) {
                invalidPassEl.style.display = "inline";
                passEl.value = "";
                submitPass.disabled = false;
                passEl.disabled = false;
                console.error(e);
                return;
            }
        }
        
        submitPass.onclick = doSubmit;
        passEl.onkeypress = function(e){
            if (!e) e = window.event;
            var keyCode = e.keyCode || e.which;
            invalidPassEl.style.display = "none";
            if (keyCode == '13'){
              // Enter pressed
              doSubmit();
              return false;
            }
        }
    })();
    </script>
  </body>
</html>
